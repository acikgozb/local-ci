pipeline {
    agent {
        label "default"
    }

    options {
        skipDefaultCheckout()
    }

    triggers {
        pollSCM('')
    }

    environment {
        TIMEOUT="sleep 900"
        BUILD_IMAGE="docker.io/library/golang:1.22.3"
        CONTAINER_NAME="${BUILD_TAG}".replaceAll("/", "-")
        EXEC="podman exec -it ${CONTAINER_NAME}"
    }

    stages {
        stage('Clean workspace') {
            steps {
                sh 'echo Cleaning previous build artifacts...'
                sh 'rm -rf ${WORKSPACE}/repo' 
                sh 'echo The workspace is cleaned up successfully.'
            }
        }

        stage('Checkout') {
            steps {
                sh 'echo Starting checkout...'
                sh 'cp -r /home/jenkins/agent/repo ${WORKSPACE}/repo'
                sh 'if [ ! -d ${WORKSPACE}/repo ]; then exit 1; else echo "Checkout is successful."; fi'
            }
        }

        stage('Start build container') {
            steps {
                sh 'echo Starting the build container ${CONTAINER_NAME} with the image ${BUILD_IMAGE}...'
                sh 'podman run -d --name ${CONTAINER_NAME} -w /ci -v ${WORKSPACE}/repo:/ci $BUILD_IMAGE $TIMEOUT'
                sh 'if [ $(podman ps --filter "status=exited" --filter "status=unknown" --noheading | wc -l) -ne 0 ]; then exit 1; else echo "Container ${CONTAINER_NAME} is started successfully."; fi'
            }
        }

        stage('Run unit tests') {
            steps {
                sh 'echo Starting running unit tests...'
                sh '$EXEC go test'
                sh 'echo Unit tests are passed successfully.'
            }
        }
    }
}
